{% extends "layout.html" %}
{% load static check_status %}

{% block calendar_extras %}

<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>

<link href="{% static 'calender_assets/fullcalendar.min.css' %}" rel='stylesheet'/>
<link href="{% static 'calender_assets/fullcalendar.print.min.css' %}" rel='stylesheet' media='print'/>
<script src="{% static 'calender_assets/moment.min.js' %}"></script>
<script src="{% static 'calender_assets/jquery.min.js' %}"></script>
<script src="{% static 'calender_assets/fullcalendar.min.js' %}"></script>
<script src="{% static 'js/loader.js' %}"></script>
<link href="{% static 'css/loader.css' %}" rel='stylesheet'>

<script>

  $(document).ready(function() {
    var booking_data = [];
    var block_data = [];
    var del_data = {};
    var event_data = [];
    dates = [];
    var multi_day = false;

    {% for booking in customuser.requestee.all %}
        {% if not booking.status|is_canceled %}
            {% for event in booking.booking.all %}
                {% if event.confirmed is True %}
                    event_data.push({
                        start: '{{ event.date|date:'Y-m-d' }}' + 'T' + getTimeFormat('{{ event.start_time|time:'H:i:s' }}'),
                        end: '{{ event.date|date:'Y-m-d' }}' + 'T' + getTimeFormat('{{ event.end_time|time:'H:i:s' }}'),
                        rendering: 'background',
                        overlap: false,
                        color: '#8d99ae',
                    });
                    var id = '{{ event.date|date:'m-d' }}' + '-{{ event.start_time|time:'H' }}';
                    block_data.push(id)
                {% else %}
                    event_data.push({
                        start: '{{ event.date|date:'Y-m-d' }}' + 'T' + getTimeFormat('{{ event.start_time|time:'H:i:s' }}'),
                        end: '{{ event.date|date:'Y-m-d' }}' + 'T' + getTimeFormat('{{ event.end_time|time:'H:i:s' }}'),
                        rendering: 'background',
                        overlap: false,
                        color: '#8d99ae',
                    });
                    var id = '{{ event.date|date:'m-d' }}' + '-{{ event.start_time|time:'H' }}';
                    block_data.push(id)
                {% endif %}
            {% endfor %}
        {% endif  %}
    {% endfor %}

    {% if customuser.multi_day %}
        multi_day = true;
    {% endif %}

  $('#calendar').fullCalendar({
    customButtons: {
    submit: {
      text: 'Save Booking!',
      click: function() {
        if (booking_data.length != 0){
        $("button").prop('disabled', true);
        alert('Are You Sure For Booking...!');
        on();
        var json_array = []
        $.each(booking_data, function(index, value){
            json_array.push(JSON.stringify(value))
        });
         $.ajax({
            url:'{% url 'save_bookings' %}',
            type: 'POST',
            headers:{
                "X-CSRFToken": '{{ csrf_token }}'
            },
            data:{
                    booking_data: json_array,
                    localite: '{{ customuser.id }}'
            },
            success:function(response){
                window.location.href = response.url;
            }
         });
        }
        else{
            alert('PLZZZZ... Select dates...!!!');
        }
      }
    },
    reset: {
      text: 'Reset!',
      click: function() {
        if (booking_data.length != 0){
            $("button").prop('disabled', true);
            location.reload(true);
        }
        else{
            alert('PLZZZZ... Select dates...!!!');
        }
      }
    },

    },
    selectable: true,
    header: {
      left: 'prev,next submit, reset',
      center: 'title',
      right: 'month,agendaWeek,agendaDay'
    },
    defaultView: 'agendaWeek',
    height: 440,
    slotDuration: '06:00:00',
    minTime: "06:00:00",
    allDaySlot: false,
    selectConstraint: {
       start: moment().format('YYYY-MM-DD'),
       end: moment().add(1, "M").format('YYYY-MM-DD')
    },
    select: function(startDate, endDate) {
      var view = $('#calendar').fullCalendar('getView');
      if (view.name == 'month'){
        $('#calendar').fullCalendar('changeView','agenda');
        $('#calendar').fullCalendar('gotoDate',startDate);
      }
      else if (multi_day == false & dates.length != 0 & jQuery.inArray(startDate.format('DD'), dates) == -1){
           alert('Multi-Day Booking is not Allowed ...!!!');
           $('#calendar').fullCalendar('unselect');
           return false;
      }
      else{
        var temp1 = moment(startDate).add(1, "d").format('YYYY-MM-DD');
        var temp2 = moment(startDate).add(6, "h").format('YYYY-MM-DD HH:mm:ss');

        if(moment(temp2).format('HH:mm:ss') != endDate.format('HH:mm:ss')){
            $('#calendar').fullCalendar('unselect');
            return false;
        }
        else if (startDate.format('YYYY-MM-DD') != endDate.format('YYYY-MM-DD') & moment(temp1).format('YYYY-MM-DD') != endDate.format('YYYY-MM-DD')){
            $('#calendar').fullCalendar('unselect');
            return false;
        }
        else{
            if (jQuery.inArray(startDate.format('MM-DD-HH'), block_data) != -1){
               $('#calendar').fullCalendar('unselect');
               return false;
            }
            else if (getKeyByValue(del_data, startDate.format('YYYY-MM-DD HH:mm:ss')) === undefined){
              id = startDate.format('MM-DD-HH')
              del_data[id] = startDate.format('YYYY-MM-DD HH:mm:ss');
              event_data.push({
                id: id,
                start: startDate.format('YYYY-MM-DD HH:mm:ss'),
                end: endDate.format('YYYY-MM-DD HH:mm:ss'),
                overlap: false,
                rendering: 'background',
              });
              booking_data.push({
                id: id,
                date: startDate.format('YYYY-MM-DD'),
                start: startDate.format('HH:mm:ss'),
                end: endDate.format('HH:mm:ss'),
              });
              dates.push(startDate.format('DD'));

              $('#calendar').fullCalendar('removeEventSource', event_data);
              $('#calendar').fullCalendar('addEventSource', event_data);
              $('#calendar').fullCalendar('refetchEvents');
            }
            else{
                key = getKeyByValue(del_data, startDate.format('YYYY-MM-DD HH:mm:ss'));
                delete del_data[key]

                index = getEventIndex(booking_data, key);
                booking_data.splice(index, 1);

                index = getEventIndex(event_data, key);
                event_data.splice(index, 1);

                index = getEventIndex(dates, moment(id).format('DD'));
                dates.splice(index, 1);

                $('#calendar').fullCalendar('removeEventSource', event_data);
                $('#calendar').fullCalendar('addEventSource', event_data);
                $('#calendar').fullCalendar('refetchEvents');
                $('#calendar').fullCalendar('unselect');
            }
        }
      }
    },
    events: event_data,
  });

  function getTimeFormat(time) {
    if(time == '00:00:00'){
        return '23:59:59';
    }
    else{
        return time;
    }
  }

  function getEventIndex(data, key) {
    ind = undefined;
    $.each(data, function(index, value) {
        if (value.id == key){
            ind = index;
            return false;
        }
    });
    return ind;
  }

  function getKeyByValue(object, value) {
    return Object.keys(object).find(key => object[key] === value);
  }


  });


</script>

<style>

  body {
    padding: 0;
    font-family: Arial, Helvetica Neue, Helvetica, sans-serif;
    font-size: 14px;
  }

  #calendar {
    max-width: auto;
    margin: 0 auto;
  }
  .uk-navbar-item, .uk-navbar-nav>li>a, .uk-navbar-toggle{font-size:14px}
  .fc-past{
    color: #8d99ae;
  }


</style>
{% endblock calendar_extras %}


{% block content %}

<div class="container">
    <h1 class="page_main_header my-3">Request Boooking</h1>
    <div class="row">
    <div class="col-3">
    </div>
    <div class="col-6">
        <div class="req_appontment_form">
        <div class="alert alert-danger my-3" id="alert" role="alert" hidden>
        </div>
            <div class="row mb-3 text-center">
                <div class="col-4">
                    <p class="border rounded" style="background: #fcf8e3;">Today Date</p>
                </div>
                <div class="col-4">
                    <p class="border rounded" style="background: #ddd;">Unavailable</p>
                </div>
                <div class="col-4">
                    <p class="border rounded">Available</p>
                </div>
            </div>
        <div id='calendar'></div>
        </div>
    </div>
    <div class="col-3">
    </div>
    </div>
</div>

<div id="overlay">
    <div id="loader-text">
        <div class="spinner-border" style="width: 8rem; height: 8rem;" role="status">
            <span class="sr-only">Loading...</span>
        </div>
    </div>
</div>

{% endblock content %}
